# AGENTS.md - VuVenu v2

Documentation des learnings et patterns pour agents futurs (Compound Engineering).

## Principe
Chaque unit√© de travail doit rendre les suivantes plus faciles. Ce fichier documente les apprentissages pour que les prochains agents/features b√©n√©ficient de l'exp√©rience accumul√©e.

---

## üèóÔ∏è Architecture Patterns

### Pattern 1: Structure BDD vs Code
**Context**: G√©n√©ration de campagnes √©chouait car code tentait d'ins√©rer colonnes inexistantes.

**Learning**:
- ‚ö†Ô∏è **TOUJOURS** v√©rifier sch√©ma BDD (`supabase/migrations/001_initial_schema.sql`) avant d'√©crire code d'insertion
- Structure `meta_campaigns`: utilise `brief` (JSONB input) + `output` (JSONB r√©sultat IA)
- Structure `meta_images`: utilise `concept_id` (INTEGER) + `variation_id` (TEXT)
- Ne PAS cr√©er colonnes individuelles pour chaque param√®tre ‚Üí utiliser JSONB

**Code Pattern**:
```typescript
// ‚úÖ BON : Aligner avec sch√©ma
await supabase.from('meta_campaigns').insert({
  commerce_id,
  brief: { product_service, objective, budget_daily, ... }, // JSONB
  output: campaignData, // JSONB
  objective,
  budget_daily,
  status: 'generating'
})
```

### Pattern 2: Migrations Supabase
**Context**: Colonnes Stripe manquantes emp√™chaient webhooks de fonctionner.

**Learning**:
- Cr√©er migration s√©par√©e pour chaque changement de sch√©ma
- Format : `XXX_description_change.sql`
- Migration 002: trigger auto-cr√©ation user
- Migration 003: colonnes Stripe (`stripe_customer_id`, `stripe_subscription_id`, `trial_ends_at`)
- Appliquer migrations manuellement via Dashboard ou CLI

### Pattern 3: Validation Limites Mensuelles
**Context**: V√©rification limites cherchait dans mauvaise table.

**Learning**:
- Compter usage dans `usage_logs` avec `action_type`, PAS dans table principale
- Utiliser `created_at >= startOfMonth` pour p√©riode
- Limites: free: 2, starter: 10, pro: 50, business: 999999

**Code Pattern**:
```typescript
const { count } = await supabase
  .from('usage_logs')
  .select('*', { count: 'exact', head: true })
  .eq('user_id', userId)
  .eq('action_type', 'meta_campaign_generated')
  .gte('created_at', startOfMonth)

if (count >= monthlyLimit) {
  throw new Error('Limite mensuelle atteinte')
}
```

---

## üîê S√©curit√© Patterns

### Pattern 1: Cl√©s API
**Context**: Cl√© Anthropic invalide car variable d'env dans `~/.zshrc` √©crasait `.env.local`.

**Learning**:
- ‚ö†Ô∏è Ne JAMAIS mettre de cl√©s API dans fichiers shell (`~/.zshrc`, `~/.bashrc`)
- Toujours dans `.env.local` du projet
- V√©rifier avec `echo $VAR_NAME` qu'aucune var syst√®me n'√©crase
- Red√©marrer serveur apr√®s changement `.env.local`

### Pattern 2: RLS Policies
**Context**: Tables n√©cessitent RLS pour s√©curit√©.

**Learning**:
- Toutes tables user-facing: RLS obligatoire
- Policy pattern: `user_id = auth.uid()` pour isolation
- Service role key bypass RLS (attention usage)

---

## üß™ Testing Patterns

### Pattern 1: Tests E2E avec Playwright
**Context**: Agent browser n√©cessite session auth.

**Learning**:
- Tests E2E sans auth: tester pages publiques seulement
- Tests avec auth: setup fixture Playwright avec session
- Ou tester manuellement apr√®s corrections

### Pattern 2: Tests de R√©gression
**Context**: Bugs trouv√©s doivent devenir tests.

**Learning**:
- Bug "failed to save campaign" ‚Üí test insertion meta_campaigns
- Bug "colonnes manquantes" ‚Üí test sch√©ma BDD complet
- Automatiser via CI/CD quand possible

---

## üé® UI/UX Patterns

### Pattern 1: Boutons CTA (btn-sparkle)
**Date**: 2026-01-18
**Context**: Uniformisation des boutons sur la landing page - certains √©taient noirs, d'autres lime, incoh√©rence visuelle.

**Learning**:
- **Classe obligatoire** : `btn-sparkle` pour TOUS les boutons CTA
- Le CSS `.btn-sparkle` dans `globals.css` force le style avec `!important`
- **Ne jamais** ajouter `bg-vuvenu-dark` ou `bg-vuvenu-lime` en inline sur un `btn-sparkle`
- L'ic√¥ne `<Sparkles />` doit √™tre AVANT le texte, pas apr√®s

**Code Pattern**:
```tsx
// ‚úÖ CORRECT
<Link href="/register" className="btn-sparkle font-bold px-8 py-3 rounded-lg">
  <Sparkles className="w-4 h-4 sparkle-icon" />
  Commencer Gratuitement
</Link>

// ‚ùå INCORRECT - les classes inline cr√©ent des conflits
<Link className="btn-sparkle bg-vuvenu-dark text-white ...">
  Commencer
  <Sparkles className="w-4 h-4" />  // Ic√¥ne apr√®s = incorrect
</Link>
```

**Style btn-sparkle** (d√©fini dans globals.css):
- Background: gradient lime (#BFFF00 ‚Üí #D4FF4D)
- Glow: halo lime autour du bouton
- Hover: scale(1.05) + translateY(-2px) + glow intensifi√©
- Active: scale(0.98)

### Pattern 2: CSS Hot Reload
**Date**: 2026-01-18
**Context**: Modifications CSS non visibles apr√®s sauvegarde.

**Learning**:
- Next.js Turbopack ne recharge pas toujours le CSS modifi√©
- **Solution** : Red√©marrer `npm run dev` si les styles ne s'appliquent pas
- V√©rifier dans DevTools que la r√®gle CSS est bien charg√©e

### Pattern 3: Gestion d'Erreurs UI
**Context**: Erreurs Supabase non affich√©es √† l'utilisateur.

**Learning**:
- Toujours capturer `error` des requ√™tes Supabase
- Afficher message d'erreur utilisateur-friendly
- Logger erreur d√©taill√©e c√¥t√© serveur pour debug

**Code Pattern**:
```typescript
// ‚ùå Mauvais
const { data } = await supabase.from('table').insert(...)

// ‚úÖ Bon
const { data, error } = await supabase.from('table').insert(...)
if (error) {
  console.error('Insert error:', error) // Log serveur
  alert(`Erreur: ${error.message}`) // Message user
  return
}
```

### Pattern 2: Loading States
**Context**: G√©n√©ration IA prend 30-90s.

**Learning**:
- Loading state explicite obligatoire
- D√©sactiver bouton submit pendant g√©n√©ration
- Message informatif: "G√©n√©ration en cours... (30-90s)"

---

## üöÄ D√©ploiement Patterns

### Pattern 1: Migrations Avant D√©ploiement
**Context**: Code d√©ploy√© avant migrations = app cass√©e.

**Learning**:
- ‚ö†Ô∏è **TOUJOURS** appliquer migrations AVANT de merger/d√©ployer
- Workflow: 1) Cr√©er migration ‚Üí 2) Appliquer √† BDD ‚Üí 3) Merger code
- Tester localement avec BDD de dev d'abord

### Pattern 2: Variables d'Env en Production
**Context**: Cl√©s API diff√©rentes dev vs prod.

**Learning**:
- Vercel: configurer env vars dans dashboard
- Ne jamais commit `.env.local`
- Documenter toutes vars n√©cessaires dans CLAUDE.md

---

## üìä Monitoring & Logging

### Pattern 1: Logging Structur√©
**Context**: Debug difficile sans logs d√©taill√©s.

**Learning**:
- Pr√©fixer logs: `[DEBUG]`, `[ERROR]`, `[INFO]`
- Logger infos cl√©s: user_id, action, timestamp
- Format: `console.error('Context:', error)` avec objet complet

### Pattern 2: Usage Tracking
**Context**: Besoin tracker usage pour limites.

**Learning**:
- Ins√©rer dans `usage_logs` apr√®s chaque g√©n√©ration r√©ussie
- Champs: `user_id`, `action_type`, `reference_id`, `tokens_used`, `cost_usd`
- Permet analytics + enforcement limites

---

## üîÑ Ralph Loop Learnings

### Learning 1: Test & Debug Automation
**Date**: 2026-01-17
**Context**: Ralph Loop automatique pour identifier et corriger bugs.

**R√©sultats**:
- 4 bugs critiques corrig√©s en 2 it√©rations
- Agents utilis√©s: @senior-developer, @vuvenu-reviewer
- 3 commits g√©n√©r√©s automatiquement
- Rapport d√©taill√©: `tasks/ralph-loop-report.md`

**Process**:
1. Cr√©er PRD d√©taill√© (`tasks/prd-test-debug-automation.md`)
2. Lancer Ralph avec agent appropri√©
3. Agent identifie bugs via analyse statique + logs
4. Corrections appliqu√©es automatiquement
5. Commit apr√®s chaque fix valid√©
6. Rapport final g√©n√©r√©

**Am√©lioration Possible**:
- Tests E2E automatiques n√©cessitent session auth (actuellement manuel)
- Appliquer migrations Supabase automatiquement (actuellement manuel)

### Learning 2: Principes Ralph Wiggum (Best Practices)
**Date**: 2026-01-18
**Context**: Analyse du site AwesomeClaude pour optimiser notre workflow.
**Source**: https://awesomeclaude.ai/ralph-wiggum

**Principes Fondamentaux**:
1. **Iteration > Perfection** - Ne pas viser parfait du premier coup
2. **Failures Are Data** - Les √©checs sont informatifs, pas des blocages
3. **Operator Skill Matters** - Bons PRDs > bon mod√®le
4. **Persistence Wins** - La loop g√®re les retries automatiquement

**Best Practices PRD**:
```markdown
# ‚ùå MAUVAIS PRD
Build a todo API and make it good.

# ‚úÖ BON PRD
Build a REST API for todos.

When complete:
- All CRUD endpoints working
- Input validation in place
- Tests passing (coverage > 80%)
- Output: <promise>COMPLETE</promise>
```

**Escape Hatches** (√† toujours configurer):
- `--max-iterations` : Safety net pour √©viter loops infinies
- Stuck detection : Si 3 retries √©chouent sur m√™me erreur ‚Üí STOP
- Partial success : Commit ce qui fonctionne m√™me si bloqu√©

**Quand utiliser Ralph**:
| ‚úÖ Bon pour Ralph | ‚ùå Pas bon pour Ralph |
|-------------------|----------------------|
| Tasks bien d√©finies | Jugement design subjectif |
| Crit√®res de succ√®s clairs | Debug production |
| V√©rification automatique | Crit√®res flous |
| Greenfield code | Approbation externe requise |

---

## üìù Conventions Code VuVenu

### TypeScript
- Strict mode obligatoire
- Pr√©f√©rer interfaces aux types pour objets
- Type assertions `as any` OK pour contourner bugs typing Supabase (documenter)

### Imports
```typescript
// 1. React/Next
import { useState } from 'react'
// 2. Libs externes
import { z } from 'zod'
// 3. Composants internes
import { Button } from '@/components/ui/button'
// 4. Lib interne
import { createClient } from '@/lib/supabase/client'
// 5. Types
import type { Script } from '@/types/database'
```

### Naming
- Components: PascalCase (`CampaignForm`)
- Functions: camelCase (`generateScript`)
- Files: kebab-case (`campaign-form.tsx`)
- API routes: kebab-case (`generate-script`)

---

## üéØ Prochaines Am√©liorations

### Court Terme
- [ ] Ajouter tests E2E Playwright complets (avec auth)
- [ ] Setup monitoring erreurs (Sentry)
- [ ] Automatiser application migrations Supabase

### Moyen Terme
- [ ] Remplacer `as any` par types propres
- [ ] Ajouter rate limiting sur APIs publiques
- [ ] Analytics usage d√©taill√©es (co√ªts par user)

### Long Terme
- [ ] CI/CD complet avec tests automatiques
- [ ] Feature flags pour rollout progressif
- [ ] Alerting automatique sur erreurs production

---

## üîó Ressources AwesomeClaude Utiles

**Source**: https://awesomeclaude.ai (explor√© 2026-01-18)

### Ressources Bookmark√©es

| Ressource | Utilit√© | URL |
|-----------|---------|-----|
| Ralph Wiggum | Technique de loop AI officielle | awesomeclaude.ai/ralph-wiggum |
| Claude Cookbook | Patterns RAG, tool use (31k stars) | github.com/anthropics/claude-cookbooks |
| awesome-mcp-servers | MCPs communautaires (79k stars) | github.com/punkpeye/awesome-mcp-servers |
| awesome-claude-code-subagents | 100+ agents sp√©cialis√©s (8k stars) | github.com/VoltAgent/awesome-claude-code-subagents |

### MCPs Recommand√©s (√† ajouter si besoin)

| MCP | Quand l'ajouter | Usage |
|-----|-----------------|-------|
| Playwright | Tests E2E avanc√©s | Browser automation |
| Supabase | Debug BDD fr√©quent | Requ√™tes directes |
| GitHub | Gestion PR avanc√©e | D√©j√† dispo via CLI |

### Ce qu'on n'utilise PAS (et pourquoi)

- **Multi-agent orchestration (oh-my-opencode)** : Over-engineering pour projet solo
- **100+ subagents** : On en utiliserait 2-3 max, complexit√© inutile
- **Agents sp√©cialis√©s frontend/backend** : Claude Opus fait d√©j√† tout

---

*Derni√®re mise √† jour: 2026-01-18 par Claude Opus 4.5*
